<!DOCTYPE html>
<html>

<head>
    <meta name="viewport"
        content="width=device-width, height=device-height, initial-scale=1.0, viewport-fit=cover, user-scalable=no, minimal-ui" />
    <meta charset="utf-8" />
    <link rel="icon" href="/static/icons/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/icons/favicon-apple-180x180.png">
    <link rel="mask-icon" href="/static/icons/mask-icon.svg" color="#03a9f4">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="msapplication-square70x70logo" content="/static/icons/tile-win-70x70.png">
    <meta name="msapplication-square150x150logo" content="/static/icons/tile-win-150x150.png">
    <meta name="msapplication-wide310x150logo" content="/static/icons/tile-win-310x150.png">
    <meta name="msapplication-square310x310logo" content="/static/icons/tile-win-310x310.png">
    <meta name="msapplication-TileColor" content="#03a9f4ff">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#03A9F4">
    <title>è¯­éŸ³åŠ©æ‰‹</title>
    <style>
        html,
        body {
            margin: 0;
            background-color: #eee;
        }

        .text-panel {
            width: 100%;
            display: flex;
            position: fixed;
            bottom: 0;
            left: 0;
            background-color: #eee;
        }

        #txtInput {
            border-radius: 10px;
            outline: none;
            padding: 10px 20px;
            width: 100%;
            margin: 10px;
            border: 1px solid gray;
        }

        .list {
            padding-bottom: 60px;
        }

        .content {
            padding: 10px 0;
            display: flex;
            overflow: auto;
        }

        .content div {
            flex: 1;
        }

        .content span {
            display: inline-block;
            padding: 5px 10px 8px 10px;
        }

        .content button {
            border: none;
            font-size: 30px;
            outline: none;
            width: 55px;
            background-color: transparent;
        }

        .right {
            text-align: right;
            padding-left: 10px;
        }

        .right span {
            background-color: purple;
            color: white;
            border-radius: 10px 10px 0px 10px;
            text-align: left;
        }

        .right button {
            float: right;

        }

        .left button {
            float: left;
        }

        .left {
            text-align: left;
            padding-right: 10px;
        }

        .left span {
            background-color: white;
            border-radius: 10px 10px 10px 0px;
        }
    </style>
</head>

<body>
    <script>
        function throttle(callback, time) {
            let timer = null
            return () => {
                if (timer) clearTimeout(timer)
                timer = setTimeout(() => {
                    callback()
                    timer = null
                }, time)
            }
        }
        let input = throttle(() => {
            let txtInput = document.querySelector("#txtInput")
            let value = txtInput.value.trim()
            if (value) {
                txtInput.value = ''
                // console.log('å‘é€ä¿¡æ¯', value)
                sendMsg(value)
            }
        }, 1000)

        function sendMsg(value) {
            addMsg('right', value)
            SocketClient.send({
                conversation_id: `${Math.random().toString(16).substr(2, 10)}${Math.random().toString(16).substr(2, 10)}`,
                text: value,
                type: "conversation/process"
            })
        }

        function addMsg(type, msg) {
            let div = document.createElement('div')
            div.className = `${type} content`
            if (type == 'right') {
                div.innerHTML = `<div><span>${msg}</span></div><button onclick="sendMsg('${msg}')">ğŸ˜˜</button>`
            } else {
                div.innerHTML = `<button>ğŸ˜</button><div><span>${msg}</span></div>`
            }

            document.querySelector(".list").appendChild(div)
            document.querySelector("#view").scrollIntoView()
        }

        // è§¦å‘è®¾å¤‡
        function triggerDevice(entity_id, msg, friendly_name) {
            // console.log(entity_id)
            let obj = null
            if (entity_id.includes('light.')) {
                obj = { domain: 'light', service: "toggle" }
            } else if (entity_id.includes('switch.')) {
                obj = { domain: 'switch', service: "toggle" }
            } else if (entity_id.includes('automation.')) {
                obj = { domain: 'automation', service: "trigger" }
            } else if (entity_id.includes('script.')) {
                obj = { domain: 'script', service: "toggle" }
            } else if (entity_id.includes('scene.')) {
                obj = { domain: 'scene', service: "turn_on" }
            }
            if (obj) {
                SocketClient.send({
                    "type": "call_service",
                    ...obj,
                    "service_data": { entity_id }
                })
                addMsg('right', msg)
                setTimeout(() => {
                    sendMsg(`${friendly_name}çš„çŠ¶æ€`)
                }, 2000)
            }
        }

    </script>
    <div class="list">
        <div class="right content">
            <div><span>Sunçš„çŠ¶æ€</span></div>
            <button onclick="sendMsg('Sunçš„çŠ¶æ€')">ğŸ˜˜</button>
        </div>
        <div class="left content">
            <button>ğŸ˜</button>
            <div><span>æ¬¢è¿ä½¿ç”¨è¯­éŸ³å°åŠ©æ‰‹</span></div>
        </div>
        <div class="right content">
            <div><span>Sunçš„å±æ€§</span></div>
            <button onclick="sendMsg('Sunçš„å±æ€§')">ğŸ˜˜</button>
        </div>
        <div class="left content">
            <button>ğŸ˜</button>
            <div><span style="font-size:12px;">
                    é›†æˆäº†äº‘éŸ³ä¹çš„æ’ä»¶åå¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤
                    <hr />
                    æ’­æ”¾éŸ³ä¹ã€æš‚åœéŸ³ä¹ã€ä¸‹ä¸€æ›²ã€ä¸Šä¸€æ›²ã€<br />
                    æˆ‘æƒ³å¬xxxçš„æ­Œã€æ’­æ”¾æ­Œæ›²xxxã€æ’­æ”¾ä¸“è¾‘xxx<br />
                    æ’­æ”¾æ–°é—»ã€æ’­æ”¾ç”µå°xxxã€æ’­æ”¾æ­Œå•xxxã€<br />
                    å°ç‚¹å£°éŸ³ã€å¤§ç‚¹å£°éŸ³
                </span></div>
        </div>
        <div class="right content">
            <div><span>æŸ¥çœ‹å…¨éƒ¨è®¾å¤‡</span></div>
            <button onclick="sendMsg('æŸ¥çœ‹å…¨éƒ¨è®¾å¤‡')">ğŸ˜˜</button>
        </div>
        <div class="left content">
            <button>ğŸ˜</button>
            <div><span style="font-size:12px;">æŸ¥çœ‹å…¨éƒ¨(ç¯ã€ä¼ æ„Ÿå™¨ã€å¼€å…³ã€è„šæœ¬ã€è‡ªåŠ¨åŒ–ã€åœºæ™¯)
                    <br />
                    ï¼ˆcameraæ‘„åƒç›‘æ§ï¼‰æŸ¥çœ‹xxxçš„ç”»é¢
                </span></div>
        </div>
    </div>
    <div id="view">&emsp;</div>
    <div class="text-panel">
        <input type="text" autofocus id="txtInput" oninput="input()" />
    </div>
    <script>
        function getRefreshToken() {
            console.log('æ­£åœ¨é‡æ–°åˆ·æ–°token')
            let hassTokens = JSON.parse(localStorage['hassTokens'])
            let { refresh_token, clientId } = hassTokens
            fetch('/auth/token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `grant_type=refresh_token&refresh_token=${refresh_token}&client_id=${clientId}`
            }).then(res => res.json()).then(res => {
                // é‡æ–°ä¿å­˜token
                hassTokens.access_token = res.access_token
                localStorage['hassTokens'] = JSON.stringify(hassTokens)
                // é‡æ–°ç™»å½•
                SocketClient.ws.onopen()
            })
        }

        let WebSocketURL = `${location.protocol == 'https' ? 'wss' : 'ws'}://${location.host}/api/websocket`
        window.SocketClient = {
            id: 0,
            ws: new WebSocket(WebSocketURL),
            init() {
                let { ws } = this
                ws.onmessage = (res) => {
                    let obj = JSON.parse(res.data)
                    if (obj.type == 'auth_invalid') {
                        getRefreshToken()
                    }
                    // console.log(obj)
                    if (this.id <= obj.id) this.id = obj.id
                    if (obj.result && Reflect.has(obj.result, 'speech')) {
                        let speech = obj.result['speech']
                        addMsg('left', speech['plain']['speech'])
                    }
                }
                ws.onopen = () => {
                    try {
                        let hassTokens = JSON.parse(localStorage['hassTokens'])
                        ws.send(JSON.stringify({
                            "type": "auth",
                            access_token: hassTokens.access_token
                        }))
                    } catch {
                        alert("ç™»å½•åè¯·é‡æ–°æ‰“å¼€æ­¤é¡µé¢")
                        location.href = '/'
                    }
                }
            },
            send(obj) {
                if ([2, 3].includes(this.ws.readyState)) {
                    alert("è¿æ¥æ–­å¼€äº†ï¼ç‚¹å‡»é‡æ–°è¿æ¥")
                    location.reload()
                } else {
                    this.ws.send(JSON.stringify({
                        id: SocketClient.id + 1,
                        ...obj
                    }))
                }

            }
        }
        SocketClient.init()
    </script>
    <!--ç™¾åº¦ç»Ÿè®¡ä»£ç ï¼Œå¯ä»¥åˆ é™¤æ‰-->
    <script>var _hmt = _hmt || []; window._hmt = _hmt; (function () { var hm = document.createElement('script'); hm.src = 'https://hm.baidu.com/hm.js?52d57d8b7588a022f89c451d06e311f0'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(hm, s) })();</script>
</body>

</html>