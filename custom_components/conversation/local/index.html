<!DOCTYPE html>
<html>

<head>
  <meta name="viewport"
    content="width=device-width, height=device-height, initial-scale=1.0, viewport-fit=cover, user-scalable=no, minimal-ui" />
  <meta charset="utf-8" />
  <meta HTTP-EQUIV="pragma" CONTENT="no-cache">
  <meta HTTP-EQUIV="Cache-Control" CONTENT="no-store, must-revalidate">
  <link rel="icon" href="/static/icons/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/static/icons/favicon-apple-180x180.png">
  <link rel="mask-icon" href="/static/icons/mask-icon.svg" color="#03a9f4">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="msapplication-square70x70logo" content="/static/icons/tile-win-70x70.png">
  <meta name="msapplication-square150x150logo" content="/static/icons/tile-win-150x150.png">
  <meta name="msapplication-wide310x150logo" content="/static/icons/tile-win-310x150.png">
  <meta name="msapplication-square310x310logo" content="/static/icons/tile-win-310x310.png">
  <meta name="msapplication-TileColor" content="#03a9f4ff">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#03A9F4">
  <title>è¯­éŸ³åŠ©æ‰‹</title>
  <style>
    html,
    body {
      margin: 0;
      background-color: #eee;
    }

    #txtInput {
      border-radius: 10px;
      outline: none;
      padding: 10px 20px;
      border: 1px solid gray;
    }

    .list {
      padding-bottom: 60px;
    }

    .content {
      padding: 10px 0;
      display: flex;
      overflow: auto;
    }

    .content div {
      flex: 1;
    }

    .content span {
      display: inline-block;
      padding: 5px 10px 8px 10px;
    }

    .content button {
      border: none;
      font-size: 30px;
      outline: none;
      width: 55px;
      background-color: transparent;
    }

    .right {
      text-align: right;
      padding-left: 10px;
    }

    .right span {
      background-color: purple;
      color: white;
      border-radius: 10px 10px 0px 10px;
      text-align: left;
    }

    .right button {
      float: right;

    }

    .left button {
      float: left;
    }

    .left {
      text-align: left;
      padding-right: 10px;
    }

    .left span {
      background-color: white;
      border-radius: 10px 10px 10px 0px;
    }
  </style>
</head>

<body>
  <div class="list">
    <div class="right content">
      <div><span>Sunçš„çŠ¶æ€</span></div>
      <button onclick="sendMsg('Sunçš„çŠ¶æ€')">ğŸ˜˜</button>
    </div>
    <div class="left content">
      <button>ğŸ˜</button>
      <div><span>æ¬¢è¿ä½¿ç”¨è¯­éŸ³å°åŠ©æ‰‹</span></div>
    </div>
    <div class="right content">
      <div><span>Sunçš„å±æ€§</span></div>
      <button onclick="sendMsg('Sunçš„å±æ€§')">ğŸ˜˜</button>
    </div>
    <div class="left content">
      <button>ğŸ˜</button>
      <div><span style="font-size:12px;">
          é›†æˆäº†äº‘éŸ³ä¹çš„æ’ä»¶åå¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤
          <hr />
          æ’­æ”¾éŸ³ä¹ã€æš‚åœéŸ³ä¹ã€ä¸‹ä¸€æ›²ã€ä¸Šä¸€æ›²ã€<br />
          æˆ‘æƒ³å¬xxxçš„æ­Œã€æ’­æ”¾æ­Œæ›²xxxã€æ’­æ”¾ä¸“è¾‘xxx<br />
          æ’­æ”¾æ–°é—»ã€æ’­æ”¾ç”µå°xxxã€æ’­æ”¾æ­Œå•xxxã€<br />
          å°ç‚¹å£°éŸ³ã€å¤§ç‚¹å£°éŸ³
        </span></div>
    </div>
    <div class="right content">
      <div><span>æŸ¥çœ‹å…¨éƒ¨è®¾å¤‡</span></div>
      <button onclick="sendMsg('æŸ¥çœ‹å…¨éƒ¨è®¾å¤‡')">ğŸ˜˜</button>
    </div>
    <div class="left content">
      <button>ğŸ˜</button>
      <div><span style="font-size:12px;">æŸ¥çœ‹å…¨éƒ¨(ç¯ã€ä¼ æ„Ÿå™¨ã€å¼€å…³ã€è„šæœ¬ã€è‡ªåŠ¨åŒ–ã€åœºæ™¯)
          <br />
          ï¼ˆcameraæ‘„åƒç›‘æ§ï¼‰æŸ¥çœ‹xxxçš„ç”»é¢
        </span></div>
    </div>
    <div id="inputPanel" class="right content">
      <div><input type="text" placeholder="è¯·ä½¿ç”¨æ‰‹æœºè¯­éŸ³è¾“å…¥æ³•" autofocus id="txtInput" onkeydown="keydownEnter()"
          oninput="input()" /></div>
      <button onclick="toggleInput()"></button>
    </div>
  </div>
  <script>
    function throttle(callback, time) {
      let timer = null
      return () => {
        if (timer) clearTimeout(timer)
        timer = setTimeout(() => {
          callback()
          timer = null
        }, time)
      }
    }

    function sendInputMsg() {
      let txtInput = document.querySelector("#txtInput")
      let value = txtInput.value.trim()
      if (value) {
        txtInput.value = ''
        // console.log('å‘é€ä¿¡æ¯', value)
        sendMsg(value)
      }
    }

    let input = throttle(() => {

      if (!window.isVoice) return;
      sendInputMsg()

    }, 1000)

    function keydownEnter() {
      if (window.event.keyCode == 13) {
        sendInputMsg()
      }
    }

    window.isVoice = true
    function setVoiceMode() {
      document.querySelector('#inputPanel button').textContent = window.isVoice ? 'ğŸ¤' : 'âœ'
    }
    setVoiceMode()

    function toggleInput() {
      let isVoice = !window.isVoice
      addMsg("left", `${isVoice ? 'è¯­éŸ³æ¨¡å¼' : 'æ–‡å­—æ¨¡å¼'}`)
      window.isVoice = isVoice
      setVoiceMode()
    }

    function sendMsg(value) {
      addMsg('right', value)
      // å‘é€æŒ‡ä»¤
      window.connection.sendMessagePromise({
        conversation_id: `${Math.random().toString(16).substr(2, 10)}${Math.random().toString(16).substr(2, 10)}`,
        text: value,
        type: "conversation/process"
      }).then(res => {
        addMsg('left', res.speech.plain.speech)
      })
    }

    function addMsg(type, msg) {
      let div = document.createElement('div')
      div.className = `${type} content`
      if (type == 'right') {
        div.innerHTML = `<div><span>${msg}</span></div><button onclick="sendMsg('${msg}')">ğŸ˜˜</button>`
      } else {
        div.innerHTML = `<button>ğŸ˜</button><div><span>${msg}</span></div>`
      }

      document.querySelector(".list").insertBefore(div, document.querySelector('#inputPanel'))
      document.querySelector("#inputPanel").scrollIntoView()
    }

    // è§¦å‘è®¾å¤‡
    function triggerDevice(entity_id, msg, friendly_name) {
      // console.log(entity_id)
      let obj = null
      if (entity_id.includes('light.')) {
        obj = { domain: 'light', service: "toggle" }
      } else if (entity_id.includes('switch.')) {
        obj = { domain: 'switch', service: "toggle" }
      } else if (entity_id.includes('automation.')) {
        obj = { domain: 'automation', service: "trigger" }
      } else if (entity_id.includes('script.')) {
        obj = { domain: 'script', service: "toggle" }
      } else if (entity_id.includes('scene.')) {
        obj = { domain: 'scene', service: "turn_on" }
      }
      if (obj) {
        addMsg('right', msg)
        // å‘é€æŒ‡ä»¤
        window.connection.sendMessagePromise({
          "type": "call_service",
          ...obj,
          "service_data": { entity_id }
        }).then(res => {
          setTimeout(() => {
            sendMsg(`${friendly_name}çš„çŠ¶æ€`)
          }, 2000)
        })
      }
    }

    // è®¢é˜…äº‹ä»¶
    setTimeout(() => {
      window.connection.subscribeEvents(() => {
        window.connection.sendMessagePromise({ type: 'get_states' }).then(res => {
          let arr = res.filter(ele => ele.entity_id.includes('persistent_notification.'))
          arr.forEach(ele => {
            let attr = ele.attributes
            addMsg('left', `${attr.title}<hr/>${attr.message}`)
          })
        })
      }, 'persistent_notifications_updated')
    }, 3000)
  </script>
  <table>
    <tbody></tbody>
  </table>
  <script type="module">
    import {
      getAuth,
      getUser,
      callService,
      createConnection,
      subscribeEntities,
      ERR_HASS_HOST_REQUIRED
    } from "./dist/index.js";

    (async () => {
      let auth;
      try {
        auth = await getAuth({
          loadTokens() {
            try {
              return JSON.parse(localStorage['voice-token'])
            } catch{ }
          },
          saveTokens: (data) => {
            localStorage['voice-token'] = JSON.stringify(data)
          }
        });
      } catch (err) {
        if (err === ERR_HASS_HOST_REQUIRED) {
          const hassUrl = `${location.protocol}//${location.host}`
          if (!hassUrl) return;
          auth = await getAuth({ hassUrl });
        } else {
          alert(`Unknown error: ${err}`);
          return;
        }
      }
      const connection = await createConnection({ auth });
      // subscribeEntities(connection, entities =>
      //   renderEntities(connection, entities)
      // );
      // Clear url if we have been able to establish a connection
      if (location.search.includes("auth_callback=1")) {
        history.replaceState(null, "", location.pathname);
      }

      // To play from the console
      window.auth = auth;
      window.connection = connection;
      getUser(connection).then(user => {
        console.log("Logged in as", user);
        window.user = user;
      });
    })();
  </script>
</body>

</html>