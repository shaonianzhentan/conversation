<!DOCTYPE html>
<html>

<head>
    <meta name="viewport"
        content="width=device-width, height=device-height, initial-scale=1.0, viewport-fit=cover, user-scalable=no, minimal-ui" />
    <meta charset="utf-8" />
    <link rel="icon" href="/static/icons/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/icons/favicon-apple-180x180.png">
    <link rel="mask-icon" href="/static/icons/mask-icon.svg" color="#03a9f4">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="msapplication-square70x70logo" content="/static/icons/tile-win-70x70.png">
    <meta name="msapplication-square150x150logo" content="/static/icons/tile-win-150x150.png">
    <meta name="msapplication-wide310x150logo" content="/static/icons/tile-win-310x150.png">
    <meta name="msapplication-square310x310logo" content="/static/icons/tile-win-310x310.png">
    <meta name="msapplication-TileColor" content="#03a9f4ff">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#03A9F4">
    <title>è¯­éŸ³åŠ©æ‰‹</title>
    <style>
        html,
        body {
            margin: 0;
            background-color: #eee;
        }

        #txtInput {
            border-radius: 10px;
            outline: none;
            padding: 10px 20px;
            border: 1px solid gray;
        }

        .list {
            padding-bottom: 60px;
        }

        .content {
            padding: 10px 0;
            display: flex;
            overflow: auto;
        }

        .content div {
            flex: 1;
        }

        .content span {
            display: inline-block;
            padding: 5px 10px 8px 10px;
        }

        .content button {
            border: none;
            font-size: 30px;
            outline: none;
            width: 55px;
            background-color: transparent;
        }

        .right {
            text-align: right;
            padding-left: 10px;
        }

        .right span {
            background-color: purple;
            color: white;
            border-radius: 10px 10px 0px 10px;
            text-align: left;
        }

        .right button {
            float: right;

        }

        .left button {
            float: left;
        }

        .left {
            text-align: left;
            padding-right: 10px;
        }

        .left span {
            background-color: white;
            border-radius: 10px 10px 10px 0px;
        }
    </style>
</head>

<body>
    <script>
        function throttle(callback, time) {
            let timer = null
            return () => {
                if (timer) clearTimeout(timer)
                timer = setTimeout(() => {
                    callback()
                    timer = null
                }, time)
            }
        }
        let input = throttle(() => {
            let txtInput = document.querySelector("#txtInput")
            let value = txtInput.value.trim()
            if (value) {
                txtInput.value = ''
                // console.log('å‘é€ä¿¡æ¯', value)
                sendMsg(value)
            }
        }, 1000)

        function sendMsg(value) {
            addMsg('right', value)
            SocketClient.send({
                conversation_id: `${Math.random().toString(16).substr(2, 10)}${Math.random().toString(16).substr(2, 10)}`,
                text: value,
                type: "conversation/process"
            })
        }

        function addMsg(type, msg) {
            let div = document.createElement('div')
            div.className = `${type} content`
            if (type == 'right') {
                div.innerHTML = `<div><span>${msg}</span></div><button onclick="sendMsg('${msg}')">ğŸ˜˜</button>`
            } else {
                div.innerHTML = `<button>ğŸ˜</button><div><span>${msg}</span></div>`
            }

            document.querySelector(".list").insertBefore(div, document.querySelector('#inputPanel'))
            document.querySelector("#inputPanel").scrollIntoView()
        }

        // è§¦å‘è®¾å¤‡
        function triggerDevice(entity_id, msg, friendly_name) {
            // console.log(entity_id)
            let obj = null
            if (entity_id.includes('light.')) {
                obj = { domain: 'light', service: "toggle" }
            } else if (entity_id.includes('switch.')) {
                obj = { domain: 'switch', service: "toggle" }
            } else if (entity_id.includes('automation.')) {
                obj = { domain: 'automation', service: "trigger" }
            } else if (entity_id.includes('script.')) {
                obj = { domain: 'script', service: "toggle" }
            } else if (entity_id.includes('scene.')) {
                obj = { domain: 'scene', service: "turn_on" }
            }
            if (obj) {
                SocketClient.send({
                    "type": "call_service",
                    ...obj,
                    "service_data": { entity_id }
                })
                addMsg('right', msg)
                setTimeout(() => {
                    sendMsg(`${friendly_name}çš„çŠ¶æ€`)
                }, 2000)
            }
        }

    </script>
    <div class="list">
        <div class="right content">
            <div><span>Sunçš„çŠ¶æ€</span></div>
            <button onclick="sendMsg('Sunçš„çŠ¶æ€')">ğŸ˜˜</button>
        </div>
        <div class="left content">
            <button>ğŸ˜</button>
            <div><span>æ¬¢è¿ä½¿ç”¨è¯­éŸ³å°åŠ©æ‰‹</span></div>
        </div>
        <div class="right content">
            <div><span>Sunçš„å±æ€§</span></div>
            <button onclick="sendMsg('Sunçš„å±æ€§')">ğŸ˜˜</button>
        </div>
        <div class="left content">
            <button>ğŸ˜</button>
            <div><span style="font-size:12px;">
                    é›†æˆäº†äº‘éŸ³ä¹çš„æ’ä»¶åå¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤
                    <hr />
                    æ’­æ”¾éŸ³ä¹ã€æš‚åœéŸ³ä¹ã€ä¸‹ä¸€æ›²ã€ä¸Šä¸€æ›²ã€<br />
                    æˆ‘æƒ³å¬xxxçš„æ­Œã€æ’­æ”¾æ­Œæ›²xxxã€æ’­æ”¾ä¸“è¾‘xxx<br />
                    æ’­æ”¾æ–°é—»ã€æ’­æ”¾ç”µå°xxxã€æ’­æ”¾æ­Œå•xxxã€<br />
                    å°ç‚¹å£°éŸ³ã€å¤§ç‚¹å£°éŸ³
                </span></div>
        </div>
        <div class="right content">
            <div><span>æŸ¥çœ‹å…¨éƒ¨è®¾å¤‡</span></div>
            <button onclick="sendMsg('æŸ¥çœ‹å…¨éƒ¨è®¾å¤‡')">ğŸ˜˜</button>
        </div>
        <div class="left content">
            <button>ğŸ˜</button>
            <div><span style="font-size:12px;">æŸ¥çœ‹å…¨éƒ¨(ç¯ã€ä¼ æ„Ÿå™¨ã€å¼€å…³ã€è„šæœ¬ã€è‡ªåŠ¨åŒ–ã€åœºæ™¯)
                    <br />
                    ï¼ˆcameraæ‘„åƒç›‘æ§ï¼‰æŸ¥çœ‹xxxçš„ç”»é¢
                </span></div>
        </div>
        <div id="inputPanel" class="right content">
            <div><input type="text" placeholder="è¯·ä½¿ç”¨æ‰‹æœºè¯­éŸ³è¾“å…¥æ³•" autofocus id="txtInput" oninput="input()" /></div>
            <button onclick="sendMsg('æŸ¥çœ‹å…¨éƒ¨è®¾å¤‡')">ğŸ˜˜</button>
        </div>
    </div>
    <script src="ha-ws.js?r=1.0"></script>
    <script>
        var SocketClient = new HaWebSocket()
        SocketClient.on('message', function (obj) {
            if (obj.type == 'auth_ok') {
                addMsg('right', 'è¿æ¥éªŒè¯æˆåŠŸï¼Œå¼€å§‹è¯´è¯å§')
                // è®¢é˜…é€šçŸ¥äº‹ä»¶
                this.send({
                    type: 'subscribe_events',
                    event_type: 'persistent_notifications_updated'
                })
            } else if (obj.type == 'result' && obj.result) {

                // è·å–è¯­éŸ³ä¿¡æ¯
                if (Reflect.has(obj.result, 'speech')) {
                    let speech = obj.result['speech']
                    addMsg('left', speech['plain']['speech'])
                }
                // æ˜¾ç¤ºé€šçŸ¥
                if (Array.isArray(obj.result)) {
                    let arr = obj.result.filter(ele => ele.entity_id.includes('persistent_notification.'))
                    arr.forEach(ele => {
                        let attr = ele.attributes
                        addMsg('left', `${attr.title}<hr/>${attr.message}`)
                    })
                }
            }
            // è·å–äº‹ä»¶åç§°
            if (obj.event && Reflect.has(obj.event, 'event_type')) {
                if (obj.event.event_type == 'persistent_notifications_updated') {
                    // è·å–æ‰€æœ‰çŠ¶æ€
                    this.send({
                        type: 'get_states'
                    })
                }
            }
        })
        SocketClient.connect()
    </script>
    <script>var _hmt = _hmt || []; window._hmt = _hmt; (function () { var hm = document.createElement('script'); hm.src = 'https://hm.baidu.com/hm.js?52d57d8b7588a022f89c451d06e311f0'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(hm, s) })();</script>
</body>

</html>